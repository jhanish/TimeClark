<!DOCTYPE html>
<html>
    <head>
        <title>The TimeClark</title>
        
        <link rel="stylesheet" href="template.css">

        <link rel="stylesheet" href="https://use.typekit.net/lms6lcx.css">

        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Archivo+Narrow&family=Caprasimo&family=Dancing+Script:wght@400;500;600;700&family=Noto+Serif+Hebrew:wght@700&display=swap" rel="stylesheet">
        <script>
        
        var clark_in_time = 0;
        var the_timer;
        var current_work_state = false;

        // The time difference between the client's system clock, and the TimeClark's.
        var client_server_timediff_seconds = 0;
        /*
        window.onload = function() {
            getClientServerTimediff();
            refreshLog();
            //heartBeat();
        }
        */

        window.addEventListener('load', function() {
            getClientServerTimediff();
            refreshLog();
        });

        function refreshLog() {
            console.log("Inside refreshLog() about to send request.");
            const req = new XMLHttpRequest();
            req.addEventListener("load", refreshLogListener);
            req.open("GET", "http://" + location.hostname + "/log")
            req.send();
            console.log("refreshLog() request sent.");
        }


        function getDataFromShortDate(when) {
            var pieces = {};
            when_date = when.toString();
            pieces.year = when_date.slice(0, 4);
            pieces.month = when_date.slice(4, 6);
            pieces.day = when_date.slice(6, 8);
            pieces.hour = when_date.slice(8, 10);
            pieces.minute = when_date.slice(10, 12);
            pieces.second = when_date.slice(12, 14);

            if (pieces.hour == 0) pieces.hour = 12; 

            console.log("Year: " + pieces.year + " month: " + pieces.month + " day: " + pieces.day + 
                        " hour: " + pieces.hour + " minute: " + pieces.minute + " second: " + pieces.second); 

            return pieces;
        }    


        function refreshLogListener() {

            console.log("**** Inside refreshLogListener() ****");
            console.log(this.response);

            json_string = this.response.substring(this.response.indexOf('['));
            console.log("json_string: " + json_string);

            try {
                json_obj = JSON.parse(json_string);
            } catch (e) {
                console.log(e + " : " + console.error(e));
            }

            console.log("JSON Object: " + json_obj);

            return_string = "<table id=\"log_table\">";

            //const reversedKeys = json_obj.keys.reverse();

            //reversedKeys.forEach(key => {
            //    console.log(key, json_obj[key]);

            first = true;
            last_date_string = "";

            saved_out_time = "";
            saved_out_time_string = "";

            for (const key in json_obj) {
                console.log(json_obj[key]);
                tmp = json_obj[key];
                date_data = getDataFromShortDate(tmp['when'])
                date_string = date_data["month"] + "/" + date_data["day"] + "/" + date_data["year"];
                
                time_string = "";
                if (date_data["hour"] > 12) {
                    time_string += (date_data["hour"] - 12).toString().padStart(2,"0");
                }
                else {
                    time_string += (date_data["hour"]).toString().padStart(2,"0");
                }

                time_string += ":" + (date_data["minute"].toString().padStart(2,"0"));

                if (date_data["hour"] < 12) {
                    time_string += " AM";
                }
                else {
                    time_string += " PM";
                }


                if (last_date_string != date_string) {
                    last_date_string = date_string;
                    return_string += "<tr class=\"daterow\"><td colspan=\"4\">" + date_string + "</td></tr>\r\n";
                    return_string += "<tr class=\"in_out_row\"><td>In</td><td>Out</td><td>Total</td><td>Note</td>\r\n";
                }

                if (first == true) {
                    if (tmp['work_state'] == true) {
                        // We have to make a partial line because the user is currently logged in.
                        return_string += "<tr><td>" + time_string + "</td><td>?</td><td>?</td><td><img src='images/note_empty.png'></td></tr>\r\n";
                    }
                    else { 
                        saved_out_time_string = time_string;
                        saved_out_time = date_data;
                    }
                    first = false;
                }
                else {
                    if (tmp['work_state'] == true) {
                        date_in = new Date(date_data['year'], date_data['month'], date_data['day'], 
                                           date_data['hour'], date_data['minute'], date_data['second']);
                        date_out = new Date(saved_out_time['year'], saved_out_time['month'], saved_out_time['day'], 
                                           saved_out_time['hour'], saved_out_time['minute'], saved_out_time['second']);
                        duration = formatDurationForDisplay(date_out.getTime() - date_in.getTime());

                        return_string += "<tr><td>" + time_string + "</td><td>" + saved_out_time_string + "</td><td>" + duration + "</td><td><img src='images/note_empty.png'></td></tr>\r\n";

                    } else {
                        saved_out_time_string = time_string;
                        saved_out_time = date_data;
                    }
                }

            }

            return_string += "</table>"

            //document.getElementById("log_div").textContent = return_string;
            document.getElementById("log_div").innerHTML = return_string;
            console.log(return_string);

        }

        function getClientServerTimediff() {
            tstamp = Math.floor(Date.now() / 1000)
            const req = new XMLHttpRequest();
            req.addEventListener("load", timeDiffRequestListener);
            req.open("GET", "http://" + location.hostname + "/timediff?timestamp=" + tstamp);
            req.send();
        }

        function heartBeat() {
            const req2 = new XMLHttpRequest();
            req2.onerror = function(error) {
                console.log("HTTP REQUEST ERRORED, RERUNNING HEARTBEAT...");
                setTimeout(heartBeat, 3000);
            };
            req2.addEventListener("load", heartBeatListener);
            req2.open("GET", "http://" + location.hostname + "/heartbeat");
            req2.send();
                        
        }

        function timeDiffRequestListener() {
            client_server_timediff_seconds = parseInt(this.responseText);
            console.log("Timediff: " + client_server_timediff_seconds);
            heartBeat();
        }

        function setBigButtonText() {
            if (current_work_state == true) {
                document.getElementById("bigbutton").textContent = "Clark Out";
            }
            else {
                document.getElementById("bigbutton").textContent = "Clark In";
            }
        }

        function clearAndHideTimer() {
            document.getElementById("timer_hours").textContent = "";
            document.getElementById("timer_days").textContent = "";
            document.getElementById("timer_minutes").textContent = "";
            document.getElementById("timer_seconds").textContent = "";

            document.getElementById("timer_table").hidden = true;

            clearTimeout(the_timer);
        }

        function startAndShowTimer() {
            document.getElementById("timer_table").hidden = false;
            the_timer = setTimeout(secondsTimerCallback, 1000);
        }

        function heartBeatListener() {
            try {
                json = JSON.parse(this.responseText);

                if (json.work_state != current_work_state) {
                    current_work_state = json.work_state;
                    setBigButtonText();

                    if (current_work_state == false) {
                        clark_in_time = 0;
                        clearAndHideTimer();    

                    }
                    else {
                        clark_in_time = json.when;
                        startAndShowTimer()
                    }

                    refreshLog();
                }
            }
            finally {
                setTimeout(heartBeat, 3000);
            }
        }

        function clarkInOutHardwareButtonClicked() {
            const req = new XMLHttpRequest();
            req.addEventListener("load", reqListener);
            req.open("GET", "http://" + location.hostname + "/buttonpress");
            req.send();
        }
        
        function secondsTimerCallback() {
            console.log("IN CALLBACK");
            
            if (clark_in_time == 0) return;

            const right_now = new Date();
            console.log("typeof(right_now)=" + typeof(right_now));
            console.log("right_now = " + right_now);
            
            console.log("clark_in_time = " + clark_in_time);
            console.log("typeof(clark_in_time) = " + typeof(clark_in_time));
            
            const clark_in_time_date = new Date(clark_in_time);
            console.log("clark_in_time_date = " + clark_in_time_date);
            
            datediff = right_now.getTime() - clark_in_time_date.getTime()
            console.log("typeof(clark_in_time_date) = " + typeof(clark_in_time_date));
            console.log("Doing calc: " + right_now.getTime() + " - " + clark_in_time_date.getTime() + " = " + datediff);
            console.log("datediff = " + datediff);
            datediff = Math.floor(datediff / 1000) + client_server_timediff_seconds;
            console.log("datediff after division: " + datediff);
            

            if (datediff > (60 * 60 * 24)) {
                days = Math.floor(datediff / (60 * 60 * 24));
                if (!days) days = "00";
                document.getElementById("timer_days").textContent = days;
                
                datediff -= days * 60 * 60 * 24;
            }

            if (datediff > (60 * 60)) {
                hours = Math.floor(datediff / (60*60));
                if (!hours) hours = "00";
                hours_display = hours.toString().padStart(2,"0")

                document.getElementById("timer_hours").textContent = hours.toString().padStart(2,"0");
                datediff -= hours * 60 * 60;
            }

            if (datediff > 60)
             {
                minutes = Math.floor(datediff / 60);
                minutes_string = minutes.toString().padStart(2, "0");
                if (minutes_string == "") minutes_string = "00";

                document.getElementById("timer_minutes").textContent = minutes_string;
                datediff -= minutes * 60;
            }

            seconds_string = datediff.toString().padStart(2,"0");
            if (!seconds_string) seconds_string = "00";
            document.getElementById("timer_seconds").textContent = seconds_string;

            the_timer = setTimeout(secondsTimerCallback, 1000);
        }
        
        function formatDurationForDisplay(duration_in_millis) {

            datediff = Math.floor(duration_in_millis / 1000);
            console.log("The datediff is: " + datediff);
            /*
            if (datediff > (60 * 60 * 24)) {
                days = Math.floor(datediff / (60 * 60 * 24));
                if (!days) days = "00";
                datediff -= days * 60 * 60 * 24;
            }
            */

            //if (datediff > (60 * 60)) {
                hours = (datediff / (60*60)).toFixed(2);
                if (!hours) hours = "0.0";
            //}

            return hours.toString() + "h";
        }

        function reqListener() {
            json = JSON.parse(this.responseText);
            
            button_text = "Clark out";
            if (json.work_state == false) {
                button_text = "Clark in";
                clearTimeout(the_timer);
                clark_in_time = ""; 
                document.getElementById("timer_table").hidden = true;
                document.getElementById("timer_days").textContent = " ";
                document.getElementById("timer_hours").textContent = " ";
                document.getElementById("timer_minutes").textContent = " ";
                document.getElementById("timer_seconds").textContent = " ";
            }
                
                
            document.getElementById("bigbutton").textContent = button_text;
            
            if (json.work_state == true) {
                document.getElementById("timer_table").hidden = false;
                clark_in_time = json.when;
                //secondsTimerCallback();
                the_timer = setTimeout(secondsTimerCallback, 1000);     
            }
        }
        </script>
    </head>
    <body>
    
        <h1>The TimeClark!</h1>
        <div class="big_button_div">
            <button id="bigbutton" type="button" onclick="clarkInOutHardwareButtonClicked();">Clark-in</button>
        </div>
        
        <div id="timer_div">

            <table hidden id="timer_table">
              <thead>
              <tr>
                <th>DAYS</th><th>HRS</th><th>MINS</th><th>SECS</th>
              </tr>
              </thead>
              <tbody>
              <tr>
                <td id="timer_days"></td><td id="timer_hours"></td><td id="timer_minutes"></td><td id="timer_seconds"></td>
              </tr>
              </tbody>
            </table>               

        </div>
    

        <div id="log_div"></div>

    </body>
</html>